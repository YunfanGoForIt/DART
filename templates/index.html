<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepWiki RAG 智能文档看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }
        .status-badge-completed { @apply bg-emerald-50 text-emerald-700 border-emerald-200; }
        .status-badge-failed { @apply bg-rose-50 text-rose-700 border-rose-200; }
        .status-badge-processing { @apply bg-blue-50 text-blue-700 border-blue-200; }
        .status-badge-pending { @apply bg-amber-50 text-amber-700 border-amber-200; }
        .status-badge-skipped { @apply bg-slate-50 text-slate-600 border-slate-200; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="text-slate-600">
    <div class="min-h-screen pb-12">
        <!-- Top Navigation / Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-600 text-white p-1.5 rounded-lg shadow-sm">
                        <i data-lucide="book-open-check" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900 tracking-tight leading-none">DeepWiki RAG</h1>
                        <p class="text-xs text-slate-500 font-medium mt-0.5">GitHub Star 智能文档生成系统</p>
                    </div>
                </div>
                <div>
                    <button onclick="triggerSync(false)" class="group flex items-center gap-2 px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium rounded-lg transition-all shadow-sm hover:shadow hover:-translate-y-0.5 active:translate-y-0">
                        <i data-lucide="rotate-cw" class="w-4 h-4 transition-transform group-hover:rotate-180"></i>
                        同步新 Star 项目
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
            <!-- Stats Overview -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 sm:gap-6">
                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)] border border-slate-100 relative overflow-hidden group hover:border-brand-200 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="layers" class="w-16 h-16 text-slate-900"></i>
                    </div>
                    <div class="text-sm font-semibold text-slate-500 mb-1">总项目数</div>
                    <div class="text-3xl font-bold text-slate-900 tracking-tight" id="total-count">-</div>
                </div>
                
                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-3px_rgba(16,185,129,0.1)] border border-slate-100 relative overflow-hidden group hover:border-emerald-200 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="check-circle-2" class="w-16 h-16 text-emerald-600"></i>
                    </div>
                    <div class="text-sm font-semibold text-slate-500 mb-1">已优化完成</div>
                    <div class="text-3xl font-bold text-emerald-600 tracking-tight" id="success-count">-</div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-3px_rgba(244,63,94,0.1)] border border-slate-100 relative overflow-hidden group hover:border-rose-200 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="alert-circle" class="w-16 h-16 text-rose-600"></i>
                    </div>
                    <div class="text-sm font-semibold text-slate-500 mb-1">处理失败</div>
                    <div class="text-3xl font-bold text-rose-600 tracking-tight" id="failed-count">-</div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-3px_rgba(100,116,139,0.1)] border border-slate-100 relative overflow-hidden group hover:border-slate-300 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="skip-forward" class="w-16 h-16 text-slate-600"></i>
                    </div>
                    <div class="text-sm font-semibold text-slate-500 mb-1">冷门跳过</div>
                    <div class="text-3xl font-bold text-slate-600 tracking-tight" id="skipped-count">-</div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-[0_2px_10px_-3px_rgba(59,130,246,0.1)] border border-slate-100 relative overflow-hidden group hover:border-brand-200 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="loader-2" class="w-16 h-16 text-brand-600"></i>
                    </div>
                    <div class="text-sm font-semibold text-slate-500 mb-1">正在处理</div>
                    <div class="text-3xl font-bold text-brand-600 tracking-tight" id="pending-count">-</div>
                </div>
            </div>

            <!-- Repository List -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div class="flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 text-slate-400"></i>
                        <h2 class="font-bold text-slate-800">处理记录</h2>
                    </div>
                    <button onclick="loadRepos()" class="text-sm font-medium text-brand-600 hover:text-brand-800 flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-brand-50">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> 刷新列表
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase tracking-wider text-xs font-semibold">
                            <tr>
                                <th class="px-6 py-4">代码仓库</th>
                                <th class="px-6 py-4">处理状态</th>
                                <th class="px-6 py-4">飞书文档</th>
                                <th class="px-6 py-4">最后更新时间</th>
                            </tr>
                        </thead>
                        <tbody id="repo-list" class="divide-y divide-slate-100">
                            <!-- Items will be injected here -->
                        </tbody>
                    </table>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="hidden py-12 flex flex-col items-center justify-center text-center">
                        <div class="bg-slate-50 p-4 rounded-full mb-3">
                            <i data-lucide="inbox" class="w-8 h-8 text-slate-300"></i>
                        </div>
                        <p class="text-slate-500 font-medium">暂无处理记录</p>
                        <p class="text-xs text-slate-400 mt-1">点击右上角同步按钮开始获取项目</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const statusMap = {
            'completed': { text: '已完成', class: 'status-badge-completed', icon: 'check' },
            'failed': { text: '失败', class: 'status-badge-failed', icon: 'x' },
            'processing': { text: '处理中', class: 'status-badge-processing', icon: 'loader-2' },
            'pending': { text: '等待中', class: 'status-badge-pending', icon: 'clock' },
            'skipped': { text: '已跳过', class: 'status-badge-skipped', icon: 'skip-forward' }
        };

        async function loadRepos() {
            try {
                const response = await fetch('/api/repos');
                const repos = await response.json();
                
                const tbody = document.getElementById('repo-list');
                const emptyState = document.getElementById('empty-state');
                
                if (repos.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                tbody.innerHTML = '';

                let stats = { total: 0, success: 0, failed: 0, skipped: 0, pending: 0 };

                repos.forEach(repo => {
                    stats.total++;
                    if (repo.status === 'completed') stats.success++;
                    else if (repo.status === 'failed') stats.failed++;
                    else if (repo.status === 'skipped') stats.skipped++;
                    else stats.pending++;

                    const statusConfig = statusMap[repo.status] || { text: repo.status, class: 'bg-slate-100 text-slate-600', icon: 'help-circle' };
                    const isProcessing = repo.status === 'processing' || repo.status === 'pending';
                    const isRetryable = repo.status === 'failed' || repo.status === 'skipped';
                    
                    // Construct DeepWiki URL
                    const deepwikiUrl = `https://deepwiki.com/${repo.repo_name}`;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50/80 transition-colors group';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-semibold text-slate-900 text-base mb-1">${repo.repo_name}</div>
                            <div class="flex gap-3 items-center">
                                <a href="${repo.repo_url}" target="_blank" class="text-xs font-medium text-slate-500 hover:text-slate-800 flex items-center gap-1 transition-colors">
                                    <i data-lucide="github" class="w-3.5 h-3.5"></i> GitHub
                                </a>
                                <span class="text-slate-300 text-xs">|</span>
                                <a href="${deepwikiUrl}" target="_blank" class="text-xs font-medium text-orange-500 hover:text-orange-600 flex items-center gap-1 transition-colors">
                                    <i data-lucide="external-link" class="w-3.5 h-3.5"></i> DeepWiki
                                </a>
                            </div>
                        </td>
                        <td class="px-6 py-4 align-top">
                            <div class="flex flex-col items-start gap-2">
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold border ${statusConfig.class} gap-1.5">
                                        <i data-lucide="${statusConfig.icon}" class="w-3 h-3 ${isProcessing ? 'animate-spin' : ''}"></i>
                                        ${statusConfig.text}
                                    </span>
                                    ${isRetryable ? `
                                        <button onclick="retryRepo('${repo.repo_id}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-xs bg-white hover:bg-slate-50 text-slate-700 px-2 py-1 rounded border border-slate-200 shadow-sm flex items-center gap-1">
                                            <i data-lucide="refresh-ccw" class="w-3 h-3 text-slate-400"></i> 重试
                                        </button>
                                    ` : ''}
                                </div>
                                ${repo.error_message ? `
                                    <div class="text-xs ${repo.status === 'skipped' ? 'text-slate-500 bg-slate-50 border-slate-200' : 'text-rose-500 bg-rose-50 border-rose-100'} px-2 py-1 rounded max-w-sm break-all leading-relaxed border">
                                        ${repo.error_message}
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${repo.feishu_doc_token ? 
                                `<a href="https://feishu.cn/docx/${repo.feishu_doc_token}" target="_blank" class="inline-flex items-center gap-1.5 font-mono text-xs bg-brand-50 text-brand-700 px-2.5 py-1.5 rounded-md hover:bg-brand-100 border border-brand-100 transition-colors">
                                    <i data-lucide="file-text" class="w-3.5 h-3.5"></i>
                                    ${repo.feishu_doc_token.slice(0, 8)}...
                                 </a>` : 
                                '<span class="text-slate-300 text-xs italic">尚未生成</span>'}
                        </td>
                        <td class="px-6 py-4 text-slate-400 text-xs font-mono">
                            ${new Date(repo.updated_at).toLocaleString('zh-CN', { hour12: false })}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Render Icons
                lucide.createIcons();

                // Update Stats with animation
                animateValue('total-count', parseInt(document.getElementById('total-count').textContent) || 0, stats.total, 500);
                animateValue('success-count', parseInt(document.getElementById('success-count').textContent) || 0, stats.success, 500);
                animateValue('failed-count', parseInt(document.getElementById('failed-count').textContent) || 0, stats.failed, 500);
                animateValue('skipped-count', parseInt(document.getElementById('skipped-count').textContent) || 0, stats.skipped, 500);
                animateValue('pending-count', parseInt(document.getElementById('pending-count').textContent) || 0, stats.pending, 500);

            } catch (error) {
                console.error('Error loading repos:', error);
            }
        }

        // Helper for number animation
        function animateValue(id, start, end, duration) {
            if (isNaN(start)) start = 0;
            if (start === end) return;
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerHTML = end;
                }
            };
            window.requestAnimationFrame(step);
        }

        async function retryRepo(repoId) {
            try {
                const btn = event.target.closest('button');
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> 提交中...';
                lucide.createIcons();
                
                const response = await fetch(`/api/retry/${repoId}`, { method: 'POST' });
                if (response.ok) {
                    // Optimistic update
                    loadRepos();
                } else {
                    alert('重试请求失败');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error retrying repo:', error);
                alert('系统错误，请查看控制台');
            }
        }

        async function triggerSync(syncAll) {
            try {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 同步中...';
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                lucide.createIcons();

                await fetch(`/trigger?sync_all=${syncAll}`, { method: 'POST' });
                
                // Show a toast or feedback
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> 同步已触发';
                    lucide.createIcons();
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        lucide.createIcons();
                    }, 2000);
                    loadRepos();
                }, 1000);
            } catch (error) {
                console.error('Error triggering sync:', error);
                alert('同步触发失败');
                btn.disabled = false;
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        // Initial load
        lucide.createIcons();
        loadRepos();
        // Poll every 5 seconds
        setInterval(loadRepos, 5000);
    </script>
</body>
</html>
